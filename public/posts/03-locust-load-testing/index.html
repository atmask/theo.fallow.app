<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Load Testing Applications with Locust | Ben Mask</title>
<meta name="keywords" content="cloud, load testing, locust, SRE, python, poetry">
<meta name="description" content="Big Idea I was recently tasked with configuring automated load tests to validate the health of a service under load and to identify bottlenecks and limits at which the service became overloaded. Up until this point, I had not worked first-hand with any load-testing frameworks. Although there are many great load testing tools out there like JMeter, K6s, and Locust, I decided to get started with Locust as it is a framework I had heard of before and is a pure Python framework (Python is the language I think in right now).">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/03-locust-load-testing/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/03-locust-load-testing/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Ben Mask (Alt + H)">Ben Mask</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Load Testing Applications with Locust
    </h1>
    <div class="post-meta"><span title='2024-07-22 21:22:31 -0400 EDT'>July 22, 2024</span>&nbsp;·&nbsp;8 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#big-idea" aria-label="Big Idea">Big Idea</a></li>
                <li>
                    <a href="#setting-up-my-first-locust-project" aria-label="Setting Up my First Locust Project">Setting Up my First Locust Project</a><ul>
                        
                <li>
                    <a href="#installing-dependencies-and-virtual-environment-setup" aria-label="Installing Dependencies and Virtual Environment Setup">Installing Dependencies and Virtual Environment Setup</a></li>
                <li>
                    <a href="#writing-a-simple-locust-test" aria-label="Writing a Simple Locust Test">Writing a Simple Locust Test</a></li>
                <li>
                    <a href="#managing-different-types-of-application-use-cases" aria-label="Managing Different Types of Application Use Cases">Managing Different Types of Application Use Cases</a></li>
                <li>
                    <a href="#managing-authentication-and-secrets" aria-label="Managing Authentication and Secrets">Managing Authentication and Secrets</a></li></ul>
                </li>
                <li>
                    <a href="#running-the-final-result" aria-label="Running the Final Result">Running the Final Result</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="big-idea">Big Idea<a hidden class="anchor" aria-hidden="true" href="#big-idea">#</a></h1>
<p>I was recently tasked with configuring automated load tests to validate the health of a service under load and to identify bottlenecks and limits at which the service became overloaded. Up until this point, I had not worked first-hand with any load-testing frameworks. Although there are many great load testing tools out there like JMeter, K6s, and Locust, I decided to get started with Locust as it is a framework I had heard of before and is a pure Python framework (Python is the language I think in right now). To rewind, load testing frameworks allow engineers to programmatically produce stress on a system by simulating a large volume of incoming requests to that system. Requests can be, but are not limited to, HTTP calls. You can also load test with gRPC or IoT protocols like MQTT. Locust is an open-source Python-based load testing framework. With Locust, all user behaviour is defined in Python code and tests can be executed from a single machine or distributed across many machines.</p>
<p>If you&rsquo;d like to borrow a template for starting a Locust project, you can find my Locust boilerplate project on GitHub: <a href="https://github.com/atmask/locust-template">https://github.com/atmask/locust-template</a></p>
<h1 id="setting-up-my-first-locust-project">Setting Up my First Locust Project<a hidden class="anchor" aria-hidden="true" href="#setting-up-my-first-locust-project">#</a></h1>
<p>When setting up my Locust project, I decided to manage my project with <code>poetry</code>. <code>poetry</code> is a tool for managing the different aspect of Python projects, such as dependencies and packaging, in a deterministic way.</p>
<p>To get started, I set up the following basic project structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>locust-tests
</span></span><span style="display:flex;"><span>│
</span></span><span style="display:flex;"><span>├── LoadTests
</span></span><span style="display:flex;"><span>│   ├── __init__.py
</span></span><span style="display:flex;"><span>│   ├── locustfile.py
</span></span><span style="display:flex;"><span>│   └── settings.py
</span></span><span style="display:flex;"><span>└── README.md
</span></span></code></pre></div><blockquote>
<p><strong>Note:</strong> # Do not worry about the contents of the <code>LoadTests/</code> dir. I have added them but for now, the files can be left blank</p>
</blockquote>
<h2 id="installing-dependencies-and-virtual-environment-setup">Installing Dependencies and Virtual Environment Setup<a hidden class="anchor" aria-hidden="true" href="#installing-dependencies-and-virtual-environment-setup">#</a></h2>
<p>I won&rsquo;t go into detail about the installation and general usage of <code>poetry</code> here but will provide the steps to get the project up and running.</p>
<blockquote>
<p>🛠️ <strong>Note:</strong> If you don&rsquo;t care to use <code>poetry</code>, you can also just add a venv using <code>python -m venv .venv</code> and set up the following <code>requirements.txt</code> file for something quick and easy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># requirements.txt file</span>
</span></span><span style="display:flex;"><span>locust
</span></span></code></pre></div></blockquote>
<p>First, initialize the new <code>poetry</code> managed project from <code>/locust-tests</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>poetry init
</span></span></code></pre></div><p>I like to have my virtual environment contained within my project so I also add a <code>poetry.toml</code> file to the root of my project with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">virtualenvs</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">in-project</span> = <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>Finally, you can add the dependencies using <code>potery add</code>. This will install the package along with its dependencies and store the dependencies in the <code>pyproject.toml</code> file and a <code>poetry.lock</code> file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>poetry add locust
</span></span></code></pre></div><p>Your project structure should now resemble the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>locust-tests
</span></span><span style="display:flex;"><span>│
</span></span><span style="display:flex;"><span>├── LoadTests
</span></span><span style="display:flex;"><span>│   ├── __init__.py
</span></span><span style="display:flex;"><span>│   ├── locustfile.py
</span></span><span style="display:flex;"><span>│   └── settings.py
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>├── poetry.lock
</span></span><span style="display:flex;"><span>├── poetry.toml
</span></span><span style="display:flex;"><span>├── pyproject.toml
</span></span><span style="display:flex;"><span>└── struct.txt
</span></span></code></pre></div><h2 id="writing-a-simple-locust-test">Writing a Simple Locust Test<a hidden class="anchor" aria-hidden="true" href="#writing-a-simple-locust-test">#</a></h2>
<p>To get started let&rsquo;s write a simple test that visits the main page for a website. To do this we have to write a class that represents some type of &ldquo;user&rdquo; of the system. We will give this user behaviours by writing functions and decorating those functions with <code>@task</code> decorator. When Locust runs, it will, by default, find all of the defined User classes in <code>locutfile.py</code> and randomly execute the <code>@task</code> decorated functions.</p>
<p>Here is an example for a first test. This example User class extends Locust&rsquo;s base HttpUser class and defines a behaviour/task for visiting the root page of a site.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># locustfile.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> locust <span style="color:#f92672">import</span> HttpUser, task
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebUser</span>(HttpUser):
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_main_page</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;Visit the main page of the domain&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span></code></pre></div><p>You may notice that the <code>GET</code> request does not specify a domain or scheme. This is because the Locust UI allows you to configure the domain you will run requests against interactively. Locust then builds an <code>Environment</code> object that gets passed to the <code>HttpUser</code> class (and any class that extends it) in the constructor. The <code>client</code> then automatically uses the configured domain as the base url for the requests.</p>
<p>You can now launch the Locust server and run this first Locust test!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## If you are using poetry</span>
</span></span><span style="display:flex;"><span>poetry shell
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## If you are using a venv</span>
</span></span><span style="display:flex;"><span>. .venv/bin/activate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Enter the project containing the locustfile.py and run the locust server</span>
</span></span><span style="display:flex;"><span>cd LoadTests/
</span></span><span style="display:flex;"><span>locust
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Expected output</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Starting web interface at http://0.0.0.0:8089
</span></span></code></pre></div><p>You should be able to navigate to the above url in your browser and see the Locust UI.
<img loading="lazy" src="images/locust-dashboard.png" alt="Locust Dashboard"  />
</p>
<h2 id="managing-different-types-of-application-use-cases">Managing Different Types of Application Use Cases<a hidden class="anchor" aria-hidden="true" href="#managing-different-types-of-application-use-cases">#</a></h2>
<p>In reality, you&rsquo;ll want to add more complex behaviours to your load tests. You likely also want to group the behaviours/tasks that you are automating to run against your server into different groups of user classes. This will let you define the behaviours of users in different scenarios such as an unauthenticated user vs an authenticated user.</p>
<p>I will provide a project structure that seems scalable and maintainable to me from a code perspective for expanding to this next part of developing a Locust project. This project structure adds an additional package named <code>behaviours</code>. You could name it <code>users</code> but I chose what I felt was most clear to me. In this package, we can define different subclasses of HttpUser and group related behaviours inside User classes. In this example, I have added an unauthenticated user and an authenticated user.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>locust-tests
</span></span><span style="display:flex;"><span>│
</span></span><span style="display:flex;"><span>├── LoadTests
</span></span><span style="display:flex;"><span>│   ├── behaviours
</span></span><span style="display:flex;"><span>│   │   ├── __init__.py
</span></span><span style="display:flex;"><span>│   │   ├── unauthenticatedUser.py
</span></span><span style="display:flex;"><span>│   │   └── authenticatedUser.py
</span></span><span style="display:flex;"><span>│   ├── __init__.py
</span></span><span style="display:flex;"><span>│   ├── locustfile.py
</span></span><span style="display:flex;"><span>│   └── settings.py
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>├── poetry.lock
</span></span><span style="display:flex;"><span>├── poetry.toml
</span></span><span style="display:flex;"><span>├── pyproject.toml
</span></span><span style="display:flex;"><span>└── struct.txt
</span></span></code></pre></div><p>Here is some example content for the unauthenticated user:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">## LoadTests/behaviours/unauthenticatedUser.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> locust <span style="color:#f92672">import</span> HttpUser, task
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnauthenticatedUser</span>(HttpUser):
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_main_page</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;Visit the main page of the domain&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_register_page</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;Visit the registration page&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/register&#34;</span>)
</span></span></code></pre></div><p>Now, you might be wondering: &ldquo;What about an authenticated user? How do I manage logging in? Do I need to do this before each test?&rdquo;. All great questions. I will first answer them with a naive solution and then improve upon that answer below.</p>
<h2 id="managing-authentication-and-secrets">Managing Authentication and Secrets<a hidden class="anchor" aria-hidden="true" href="#managing-authentication-and-secrets">#</a></h2>
<p>Let&rsquo;s take a look at setting up our <code>authenticatedUser</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">## LoadTests/behaviours/authenticatedUser.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> HttpUser<span style="color:#f92672">,</span> task
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dataclasses <span style="color:#f92672">import</span> dataclass
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> requests.auth <span style="color:#f92672">import</span> HTTPBasicAuth
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserAuthConfig</span>:
</span></span><span style="display:flex;"><span>    username: str
</span></span><span style="display:flex;"><span>    password: str
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticatedUser</span>(HttpUser):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, user_auth_config: UserAuthConfig, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_user_auth_config <span style="color:#f92672">=</span> user_auth_config
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_start</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;Locust call on_start when a simulated user starts running&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>login()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;Login using basic auth&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;/login&#39;</span>, 
</span></span><span style="display:flex;"><span>            auth<span style="color:#f92672">=</span>HTTPBasicAuth(self<span style="color:#f92672">.</span>_user_auth_config<span style="color:#f92672">.</span>username, self<span style="color:#f92672">.</span>_user_auth_config<span style="color:#f92672">.</span>password)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_profile</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;Visit the authenticated user&#39;s profile&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;/profile&#39;</span>)
</span></span></code></pre></div><p>This is great! But what if your application supports different authentication mechanisms? And what if multiple different user&rsquo;s all need authentication? This is where we can improve the above example by adding some additional structuring to the project to keep things DRY and consistent. This will be done by creating an interface that must be implemented by all authenticated user classes and adding a couple of authentication base classes to implement the interface with different auth mechanisms.</p>
<p>Let&rsquo;s look at the new project structure with the changes that will be introduced:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>locust-tests
</span></span><span style="display:flex;"><span>│
</span></span><span style="display:flex;"><span>├── LoadTests
</span></span><span style="display:flex;"><span>│   ├── authentication
</span></span><span style="display:flex;"><span>│   │   ├── __init__.py
</span></span><span style="display:flex;"><span>│   │   ├── interface.py
</span></span><span style="display:flex;"><span>│   │   ├── oauth.py
</span></span><span style="display:flex;"><span>│   │   └── token.py
</span></span><span style="display:flex;"><span>│   │ 
</span></span><span style="display:flex;"><span>│   ├── behaviours
</span></span><span style="display:flex;"><span>│   │   ├── __init__.py
</span></span><span style="display:flex;"><span>│   │   ├── unauthenticatedUser.py
</span></span><span style="display:flex;"><span>│   │   └── authenticatedUser.py
</span></span><span style="display:flex;"><span>│   ├── __init__.py
</span></span><span style="display:flex;"><span>│   ├── locustfile.py
</span></span><span style="display:flex;"><span>│   └── settings.py
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>├── poetry.lock
</span></span><span style="display:flex;"><span>├── poetry.toml
</span></span><span style="display:flex;"><span>├── pyproject.toml
</span></span><span style="display:flex;"><span>└── struct.txt
</span></span></code></pre></div><p>Let&rsquo;s take a look at the contents of each file. First, the interface</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">## LoadTests/authentication/interface.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> HttpUser
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> abstractmethod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IAuthUser</span>(HttpUser):
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_start</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;Add the call to authenticate when the user starts&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_authenticate_user()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_authenticate_user</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;Authenticate the user via the auth mechanism&#39;&#39;&#39;</span>
</span></span></code></pre></div><p>Now, let&rsquo;s look at an example with token authentication</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> LoadTests.authentication,interface <span style="color:#f92672">import</span> IAuthUser
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserAuthConfig</span>:
</span></span><span style="display:flex;"><span>    username: str
</span></span><span style="display:flex;"><span>    password: str
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenAuthUser</span>(IAuthUser):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, user_auth_config: UserAuthConfig, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_user_auth_config <span style="color:#f92672">=</span> user_auth_config
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_token <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_authenticate_user</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;Implement the authentication method using basic auth&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;/login&#39;</span>, 
</span></span><span style="display:flex;"><span>            auth<span style="color:#f92672">=</span>HTTPBasicAuth(self<span style="color:#f92672">.</span>_user_auth_config<span style="color:#f92672">.</span>username, self<span style="color:#f92672">.</span>_user_auth_config<span style="color:#f92672">.</span>password)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Grab the token (yes...no validation for this example)</span>
</span></span><span style="display:flex;"><span>        token <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;token&#34;</span>)
</span></span></code></pre></div><p>Now that we have these classes we can simplify the original <code>authenticatedUser</code> class:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">## LoadTests/behaviours/authenticatedUser.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> LoadTests.authentication.token <span style="color:#f92672">import</span> TokenAuthUser, UserAuthConfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticatedUser</span>(TokenAuthUser):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;Define a collection of tasks that can be performed by an authenticated user&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_profile</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;Visit the authenticated user&#39;s profile&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;/profile&#39;</span>)
</span></span></code></pre></div><p>This reduces the scope of the <code>AuthenticatedUser</code> class and makes it easier to set up another class extending the TokenAuthUser. One could imagine having a class for <code>AdminUser</code> and <code>EditorUser</code> and defining behaviours for each type where these both extend <code>TokenAuthUser</code>.</p>
<p>This final step to run this new configuration involves importing the behaviour classes into the Locustfile and configuring them:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">## LoadTests/locustfile.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> LoadTests.behaviours <span style="color:#f92672">import</span> unauthenticatedUser, authenticatedUser
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> LoadTests.authentication.token <span style="color:#f92672">import</span> UserAuthConfig
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> settings <span style="color:#f92672">import</span> user_auth_config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnauthenticatedUser</span>(unauthenticatedUser<span style="color:#f92672">.</span>UnauthenticatedUser):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, environment):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__(environment)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticatedUser</span>(authenticatedUser<span style="color:#f92672">.</span>AuthenticatedUser):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, environment):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39; Get the user_auth_config object from settings.py and pass via super&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__(user_auth_config, environment)
</span></span></code></pre></div><blockquote>
<p><strong>Note:</strong> Locust will only pick up and run classes defined in the locustfile (i.e. not instances of classes so create a subclass of each that is configured). You will notice that both of these classes only take <code>self</code> and <code>environment</code> as constructor args. The AuthenticatedUser class, however, passes a <code>user_auth_config</code> object to its parent when initialized.</p>
</blockquote>
<h1 id="running-the-final-result">Running the Final Result<a hidden class="anchor" aria-hidden="true" href="#running-the-final-result">#</a></h1>
<p>You can now run the final result from within the <code>LoadTests/</code> dir by running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /LoadTests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Using the class picker flag will allow you to control via the UI what behaviours/users you want to run in your load test</span>
</span></span><span style="display:flex;"><span>locust --class-picker
</span></span></code></pre></div><p>Your server should come up and you can begin to configure tests!
<img loading="lazy" src="images/locust-dashboard2.png" alt="locust-dashboard"  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/cloud/">Cloud</a></li>
      <li><a href="http://localhost:1313/tags/load-testing/">Load Testing</a></li>
      <li><a href="http://localhost:1313/tags/locust/">Locust</a></li>
      <li><a href="http://localhost:1313/tags/sre/">SRE</a></li>
      <li><a href="http://localhost:1313/tags/python/">Python</a></li>
      <li><a href="http://localhost:1313/tags/poetry/">Poetry</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/04-understanding-ipv4-addressing/">
    <span class="title">« Prev</span>
    <br>
    <span>Understanding CIDR Blocks and IPv4 Addressing</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/02-bare-metal-k3s-on-rpi-part-2/">
    <span class="title">Next »</span>
    <br>
    <span>Part 2: Building a Bare-metal Kubernetes Cluster on Raspberry Pis</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Ben Mask</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
